@model HotelsModel
﻿@using Microsoft.AspNet.Identity
@using ProjektGrupowyGis.Models
@using GridMvc.Html
@{
    ViewBag.Title = "Index";
}

<script src="@Url.Content("~/Scripts/jquery-1.10.2.min.js")"></script>
<link href="@Url.Content("~/Content/Gridmvc.css")" rel="stylesheet" type="text/css" />
<script src="@Url.Content("~/Scripts/gridmvc.min.js")" type="text/javascript"> </script>
<link href="@Url.Content("~/Content/style.css")" rel = "stylesheet" />

<script>
    document.onreadystatechange = function(){
        document.getElementById("529-star-1").value;
        var allElements = document.getElementsByClassName("rating");
        Array.prototype.forEach.call(allElements, function(el){
            var id = el.id;
            var rate = id.substring(id.lastIndexOf('-') + 1)
            if(rate != "0"){
                var hotelId = id.substring(0, id.indexOf('-')+1);
                var sId = "" + hotelId + "star-";
                initRate(sId, rate);
            }
;        })
    }
        function rateHover(element) {
            var count = element.attributes.value.value;
            var id = element.attributes.id.value;
            var hotelId = id.substring(0, id.indexOf('-'));
            for (var i = count; i > 0; i--) {
                var starId = "" + hotelId + "-star-" + i;
                document.getElementById(starId).className = "starYellow clearButton";
            }
            for (var i = 5; i > count; i--) {
                var starId = "" + hotelId + "-star-" + i;
                document.getElementById(starId).className = "starOutline clearButton";
            }
        }

        function rateClick(element) {
            var id = element.attributes.id.value;
            var hotelId = id.substring(0, id.indexOf('-'));
            var userRate = id.substring(id.lastIndexOf('-') + 1);
            console.log(userRate);
            console.log(hotelId);
            var ratee = {
                'userLogin': "@User.Identity.Name",
                'hotelId': hotelId,
                'rate': userRate
            };
            console.log(JSON.stringify(ratee));
            $.ajax({
                url: "/Hotels/RateHotel",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(ratee),
                success: function (result) {
                    setTimeout(function () {
                        setRate(element, result.response);
                    }, 500);
                }
            });
        }

        function initRate(id, count){
            for (var i = count; i > 0; i--) {
                var starId = "" + id + i;
                document.getElementById(starId).className = "starYellow clearButton";
            }
            for (var i = 5; i > count; i--) {
                var starId = "" + id + i;
                document.getElementById(starId).className = "starOutline clearButton";
            }
        }

        function setRate(element, count) {
            console.log(element);
            console.log(count);
            var id = element.attributes.id.value;
            var hotelId = id.substring(0, id.indexOf('-'));
            for (var i = count; i > 0; i--) {
                var starId = "" + hotelId + "-star-" + i;
                document.getElementById(starId).className = "starYellow clearButton";
            }
            for (var i = 5; i > count; i--) {
                var starId = "" + hotelId + "-star-" + i;
                document.getElementById(starId).className = "starOutline clearButton";
            }
        }
</script>

<h2>Hotels List</h2>

<div class="panel panel-default" onload="onLoad()">
    <table class="table table-striped table-bordered table-responsive table-condensed table-hover">
        <thead>
            <tr>
                <th class="col-md-2">Name</th>
                <th class="col-md-2">Address</th>
                <th class="col-md-2">Phone number</th>
                <th class="col-md-3">Website</th>
                <th class="col-md-1">Google rate</th>

                @if (Model.CanRate)
                {
                <th>Your rate</th>
                }
                @if (Model.CanEdit)
                {
                <th></th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var h in Model.Hotels)
            {
            <tr>
                <td class="col-md-2">
                    @h.Name @h.Id_Hotel
                </td>
                <td class="col-md-2">
                    @h.FullAddress
                </td>
                <td class="col-md-2">
                    @h.Phone
                </td>
                <td class="col-md-2">
                    <a href="@h.Webpage">@h.Webpage</a>
                </td>
                <td class="col-md-1">
                    @h.Google_Rate
                </td>
                @if (Model.CanRate)
                {
                <td>
                    <div id="@h.Id_Hotel-rating-@h.User_Rate" class="rating">
                        <button id="@h.Id_Hotel-star-1" class="starOutline clearButton" value="1" onmouseout="setRate(this, @h.User_Rate)" onmouseover="rateHover(this)" onclick="rateClick(this)"></button>
                        <button id="@h.Id_Hotel-star-2" class="starOutline clearButton" value="2" onmouseout="setRate(this, @h.User_Rate)" onmouseover="rateHover(this)" onclick="rateClick(this)"></button>
                        <button id="@h.Id_Hotel-star-3" class="starOutline clearButton" value="3" onmouseout="setRate(this, @h.User_Rate)" onmouseover="rateHover(this)" onclick="rateClick(this)"></button>
                        <button id="@h.Id_Hotel-star-4" class="starOutline clearButton" value="4" onmouseout="setRate(this, @h.User_Rate)" onmouseover="rateHover(this)" onclick="rateClick(this)"></button>
                        <button id="@h.Id_Hotel-star-5" class="starOutline clearButton" value="5" onmouseout="setRate(this, @h.User_Rate)" onmouseover="rateHover(this)" onclick="rateClick(this)"></button>
                    </div>
                </td>
                }
                @if (Model.CanEdit)
                {
                <td>
                    @Html.ActionLink("Edit", "Edit", new { idHotel = h.Id_Hotel })
                </td>
                }
            </tr>
            }
        </tbody>
    </table>
</div>

